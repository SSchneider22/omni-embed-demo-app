# Security（Omni Embed / SSO / ログ）

目的: 秘密情報流出と認証まわりの事故を避ける。

---

## 絶対禁止（Secrets）
以下をログ/標準出力/例外/テンプレ/コミット/テスト成果物に含めない:
- `.env` の中身、APIキー、client secret、アクセストークン、SSO関連値
- 署名付き/トークン付きの可能性がある埋め込みURL
- Cookie値、セッションID、ユーザー識別子の生値

運用:
- print() 禁止
- loggerでも値はマスク（先頭数文字のみ等）
- 例外メッセージに機微情報を含めない（スタックトレースの出し方にも注意）
- エラー表示は「ユーザー向け文言」と「内部ログ」を分離し、内部ログにも秘密情報を残さない

---

## Omni Embed / SSO の扱い
- `.env` の Omni 関連値（client secret等）は絶対にログ・レスポンス・テンプレに出さない
- 埋め込みURLや署名付きURLは、そのまま保存/ログ化しない（必要なら短寿命・最小保持）
- 失敗時の挙動は安全側（詳細を出しすぎない、再試行導線を作る等）

---

## SSO / Redirect 入力の扱い（Open Redirect対策）
- 外部入力（redirect、next、return_to等）は必ず検証する
- 想定外のホスト/スキーム/パスを拒否する
- 可能なら「許可リスト（アプリ内の相対パスのみ）」に寄せる
- 失敗時は固定の安全な遷移先へ戻す

---

## Cookie / セッション
- 既存のCookie属性（Secure/HttpOnly/SameSite）を弱めない
- セッションID等をログに出さない
- ユーザー存在/権限の判定ができるような過度に詳細なエラーを避ける（列挙耐性）

---

## CSRF / 状態変更（特にhtmx）
- 状態変更はPOST等で行い、GETで更新しない
- 既存のCSRF要件を崩さない（htmxのPOSTに要注意）
- 認証/権限チェックを迂回するルートを作らない

---

## 外部通信（追加する場合）
- 追加は最小限にする
- タイムアウト/例外時の挙動を安全側にする
- リクエスト/レスポンスの生ログは禁止（必要ならメタ情報のみ）