{% extends "base.html" %}

{% block title %}レポート - Omni Embed Demo{% endblock %}

{% block content %}
<div class="card">
    <h2>購買分析レポート</h2>
    <p style="margin-bottom: 1rem;"><a href="/me">← マイページに戻る</a></p>

    <div id="embed-container" style="position: relative; width: 100%; height: 800px;">
        <div id="loading" style="text-align: center; padding: 2rem;">
            <p>レポートを読み込んでいます...</p>
        </div>
        <div id="error" style="display: none;"></div>
        <iframe id="omni-iframe"
                style="width: 100%; height: 100%; border: 1px solid #ddd; border-radius: 4px; display: none;"
                sandbox="allow-scripts allow-same-origin allow-forms allow-popups">
        </iframe>
    </div>
</div>

<script>
    (async function() {
        const contentPath = "{{ content_path }}";

        if (!contentPath) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').innerHTML = '<div class="error">コンテンツパスが指定されていません</div>';
            document.getElementById('error').style.display = 'block';
            return;
        }

        try {
            const response = await fetch(`/api/embed/url?content_path=${encodeURIComponent(contentPath)}`);

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to load embed URL');
            }

            const data = await response.json();
            const iframe = document.getElementById('omni-iframe');

            iframe.src = data.url;
            iframe.style.display = 'block';
            document.getElementById('loading').style.display = 'none';

        } catch (err) {
            console.error('Error loading embed:', err);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').innerHTML = `<div class="error">エラー: ${err.message}</div>`;
            document.getElementById('error').style.display = 'block';
        }
    })();
</script>
{% endblock %}
